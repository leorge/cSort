#!/bin/bash
LANG=en_US.UTF-8; NULL=/dev/null

if which checkScripts > $NULL 2>&1; then
    check64bits  || exit
    checkScripts || exit
    inst_cmd bc setterm || exit
else
    echo -e "Please setup scripts and data in the following URLs.\n"    \
            "  scripts - https://github.com/leorge/scripts/wiki\n"    \
            "  data    - https://github.com/leorge/data/wiki"
    exit
fi

#----- Download files -----
if [ ! -f Release/cSort ]; then
    mkdir -p Release    
    wget -N -P Release https://www.dropbox.com/s/y0sxr83uu28sxer/cSort
    chmod +x Release/cSort
fi
if [ ! -f cSort.ods ]; then
#    wget -N https://www.dropbox.com/s/g3crz58greg3umf/cSort.ods # Old
    wget -N https://www.dropbox.com/s/hix339m174n3ye9/cSort.ods
fi

#----- Command analysis -----

if [ $# -lt 1 ]; then
    echo "usage : $0  log2(N)  [repeat]"
    exit
fi
log2N=$1; shift     # log2(N)
least=12
if [ $log2N -lt $least ]; then log2N=15; fi
repeat=1
if [ $# -gt 0 ]; then
    repeat=$1; shift
    if [ $repeat -le 0 ]; then repeat=1; fi
fi

#----- measurement -----

tty | grep '/dev/tty' > /dev/null && setterm --blank 0 --powerdown 0

rm -f tmp[1-9]*     # delete old tmp$$
sed -i -e '1,/^@/!d' $0     # Delete data part in this file
echo "start    : `date -u`" >> $0       # add date
echo "computer : `uname -norpv`" >> $0
echo "operator : `id -un`" >> $0
echo "option   : $log2N ${repeat:=1}" >> $0

DATA=data
for i in `seq 1 $repeat`; do echo "$0 `date` $i/$repeat" >& 2
    random.awk `echo 2^$log2N | bc` > $DATA
    for j in `seq $least $log2N`; do
        echo -n " $j" 1>&2
        N=`echo 2^$j | bc`; echo "$i:$j"
        for k in 3 h a g k; do
            (Release/cSort -N $N -$k $DATA > $NULL) 2>&1
        done
    done
    echo "" >& 2
done > tmp$$
echo "stop     : `date -u`" >> $0       # add date

#----- output -----

OUT=tmp.`basename $0`
gawk -f - tmp$$ <<'EOF' > $OUT
/:/{
    split($0, N, ":"); Nth = N[1]; Log2 = N[2]
    index(times ":", ":" Nth ":") || times = times ":" Nth
    index(numbers ":", ":" Log2 ":") || numbers = numbers ":" Log2
    next
}
/^[a-zA-Z].* [0-9]+$/ { # name - time
    name = $1
    index(names ":", ":" name ":") || names = names ":" name
	a[name,Log2,Nth] = $NF + 0
}
END {
    split(substr(names, 2), y, ":") # print "names   = " names
    split(substr(numbers, 2), x, ":") # print "numbers = " numbers
    count = split(substr(times, 2), z, ":") # print "times  = " times
    for (i in z) {  # Nth
        print  (Nth = z[i])	# first line
        printf "log2(N)"	# second line
        for (j in x) printf "\t%d", x[j]
        print ""                            # New line
        for (k in y) {    # function
            printf "%s", (name = y[k])
            for (j in x) printf "\t%d", a[name,x[j],Nth]
            print ""
        }
        print ""
    }
}
EOF

expand -t `col.awk $OUT` $OUT | tee -a $0

exit


start    : Tue Jun  6 11:34:01 UTC 2017
computer : archiso 4.8.6-1-ARCH #1 SMP PREEMPT Mon Oct 31 18:51:30 CET 2016 unknown GNU/Linux
operator : root
option   : 26 20
stop     : Tue Jun  6 13:09:18 UTC 2017
1
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      2284 3802 8721  16079 25968 49413 103346 200542 421194 879027 1842888 3897839 8129761 16974885 35487320
hole_qsort()  1831 3947 8691  14485 19159 37417 81290  168481 347415 728786 1549460 3189430 6674752 13794352 29286738
asymm_qsort() 1437 3493 8884  9767  22092 37984 79573  166189 344378 738738 1498259 3149947 6600908 13664147 28299013

2
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      2530 3871 10199 14682 27542 52430 98834  199367 419425 886448 1849722 3867339 8145591 17015806 35474867
hole_qsort()  1464 5324 8202  14994 23689 41768 78554  168932 347690 745546 1531084 3196832 6666960 13874763 28523476
asymm_qsort() 1496 2595 6786  8851  18964 38920 79370  165700 346422 737031 1524285 3120388 6519334 13584900 28169828

3
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      3026 3859 10111 15558 28485 49954 96076  202950 420578 891816 1848864 3890206 8118043 16927124 35388925
hole_qsort()  1814 2584 6566  13603 21079 41693 78275  164593 354235 732761 1542797 3225531 6685143 13897384 28983596
asymm_qsort() 2490 5439 8683  10289 18518 40957 79647  167176 350312 728742 1512670 3147101 6529901 13623167 28197645

4
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      2208 4070 9734  16044 27420 49414 97952  198378 416886 880940 1853949 3894075 8147151 16884206 35453560
hole_qsort()  1885 3963 8346  13448 18818 39744 78294  166906 347186 716229 1532322 3218714 6665795 13673219 29156858
asymm_qsort() 1468 3393 8547  13071 21689 39220 78590  164348 351376 727157 1563957 3158253 6508931 13661858 28289805

5
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      3016 3159 9737  15877 26573 48150 97667  198289 421583 883240 1845348 3863161 8119462 16980380 35567474
hole_qsort()  2491 3305 8364  12067 21419 37997 80495  165986 342199 740416 1519221 3197598 6640341 13865247 28637916
asymm_qsort() 2520 4047 4124  10965 20454 36698 78828  167771 351256 727724 1510447 3144515 6573339 13638966 28260629

6
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      2485 4835 8949  15216 27097 51909 94790  200607 422967 879620 1859628 3882925 8140621 16948391 35359332
hole_qsort()  1856 3798 5862  13193 21254 38956 79617  167444 348281 721936 1535145 3132879 6646010 13747901 29001761
asymm_qsort() 1870 3214 11083 12628 18781 40225 77851  164085 345937 742673 1508893 3131990 6571671 13633411 28183934

7
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      3010 3137 7395  15779 24160 48293 93826  201770 420002 883935 1845297 3889912 8120000 16994386 35255508
hole_qsort()  1423 4585 4930  13361 22186 38803 82530  165505 351114 733909 1549471 3211890 6717451 14161403 28596965
asymm_qsort() 1477 4015 4224  13504 22369 40774 78446  165972 346318 720760 1517682 3141918 6572693 13563667 28242716

8
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      1746 5476 10192 15758 27092 52651 96633  202215 420126 877170 1839792 3866753 8111745 16977160 35437493
hole_qsort()  1465 3071 9053  9010  21847 39319 78075  168996 352029 722305 1525503 3181260 6567118 13843335 29175742
asymm_qsort() 1845 5399 5156  13588 22226 39706 78400  165791 346938 730077 1505990 3154507 6545781 13587304 28198872

9
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      2553 3992 10513 14874 28274 49103 97470  200238 420915 881102 1854706 3865689 8175275 16901842 35468036
hole_qsort()  1789 3176 8592  14284 23443 39173 80489  165084 343868 732300 1540149 3179620 6599673 13792444 28577628
asymm_qsort() 1889 5427 7378  11998 22897 40331 77651  166850 345587 735868 1503996 3139858 6545023 13601203 28203475

10
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      2834 4813 9611  16754 23086 47832 95514  199121 419992 904458 1862089 3894546 8125178 17014706 35475285
hole_qsort()  1858 3891 5141  15075 18343 39757 80067  169285 353277 746425 1498911 3245988 6623454 13962875 29276300
asymm_qsort() 1817 3990 4252  8462  18425 38673 79279  164042 349293 726210 1503447 3143886 6554383 13563711 28365643

11
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      2247 4418 7549  15163 26693 48016 95163  200860 418284 881900 1841832 3889418 8093235 16903933 35460487
hole_qsort()  1873 2545 6054  13510 22237 39120 77070  165549 356143 729164 1542166 3158703 6633030 13820551 28663173
asymm_qsort() 1886 2553 8145  8726  22540 37987 78697  168166 348891 720296 1498492 3129630 6514582 13580245 28145979

12
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      1764 4439 8878  16220 25911 49534 97179  203356 416578 881013 1854993 3885875 8121962 16971948 35389926
hole_qsort()  1443 3152 4927  14574 19614 40773 79313  165471 350017 736679 1547187 3175702 6697335 13905026 28899004
asymm_qsort() 1859 4019 4405  14879 21388 40947 77754  164514 343200 721224 1498830 3152083 6530258 13768212 28302592

13
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      3024 4819 10148 15785 26249 49938 96456  204095 421093 882620 1859339 3893530 8126330 16993621 35377960
hole_qsort()  1862 4113 4147  11453 22506 41115 80321  165473 351079 731671 1545173 3323967 6749942 14039784 28775344
asymm_qsort() 1838 5363 10631 14757 21400 38797 78716  166572 344813 729024 1507188 3145888 6556497 13641895 28326876

14
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      3085 3978 8267  14980 26357 51056 96957  201055 418683 879647 1854246 3860714 8113575 16968980 35400516
hole_qsort()  2053 3169 8617  14420 21482 41252 79375  164570 353557 746312 1529697 3240764 6694296 13999139 28904296
asymm_qsort() 2482 3151 6655  9390  22469 39329 79578  165249 343742 722586 1494875 3203933 6498137 13572836 28251956

15
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      2952 4895 10117 15596 26778 49861 98313  203667 423117 884082 1856474 3891301 8145421 17010556 35481184
hole_qsort()  2515 2816 9812  8750  20411 39286 80530  164927 356796 740289 1549266 3195813 6690623 13948155 28925223
asymm_qsort() 1445 2619 5541  13488 21604 42187 79382  167256 352436 717770 1523643 3134927 6518975 13646764 28337685

16
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      3014 4787 13579 15413 25574 51413 97749  200479 423408 877209 1853442 3897305 8149628 16922387 35608191
hole_qsort()  1249 4137 8488  11014 22258 41236 81612  165698 344597 736312 1510351 3193198 6842253 14071732 29535590
asymm_qsort() 1221 3984 7731  13634 22809 38553 78102  163644 345091 721010 1498025 3143133 6522053 13593858 28160003

17
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      2967 4838 8200  16104 27035 51240 101312 202353 417594 876575 1852226 3882533 8130319 16941005 35447077
hole_qsort()  889  3921 6563  13146 19018 40558 81451  164581 343941 719161 1502756 3173727 6641555 14016776 29072047
asymm_qsort() 937  3139 5512  9227  22655 41691 83680  163483 349883 723561 1507949 3151248 6523169 13598768 28240498

18
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      2341 6587 8672  15721 26844 52068 98564  202364 423832 877782 1841431 3877881 8135465 16972491 35528383
hole_qsort()  2390 4054 9447  8878  20552 40478 79783  165136 342606 720459 1526180 3243633 6632590 13757562 28737959
asymm_qsort() 1485 3586 7427  11143 21851 39509 77779  167975 348535 717069 1520902 3171313 6564986 13638858 28231355

19
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      2227 4415 8771  15873 26140 53232 97498  199281 421146 878191 1843202 3880665 8118823 16961880 35499912
hole_qsort()  2446 3187 4963  14612 22279 42724 78920  162702 350158 736035 1525792 3180896 6830802 13745882 29025134
asymm_qsort() 1447 2992 4127  13538 22641 42216 79269  164695 350787 725143 1520131 3149132 6555537 13648719 28193767

20
log2(N)       12   13   14    15    16    17    18     19     20     21     22      23      24      25       26
qsort(3)      3004 3842 8276  15191 24224 50902 96299  202118 421944 878005 1842716 3880817 8145402 16992431 35421002
hole_qsort()  1480 3472 4254  13306 21325 39835 82451  165031 354590 751646 1529147 3287390 6851301 13972583 29243155
asymm_qsort() 2507 3126 4318  13983 21660 41852 78356  167669 353044 731362 1509095 3198307 6574035 13596838 28243124

@
